# 网络层

- 作者：李竹楠
- 日期：2023/11/25

## 概述

因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。

使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

## IP协议

### IP数据报格式

![AR](../../../pics/6.jpg "AR")

- **版本**: 有 4（IPv4）和 6（IPv6）两个值；
- **首部长度**: 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
- **区分服务**: 用来获得更好的服务，一般情况下不使用。
- **总长度**: 包括首部长度和数据部分长度。
- **生存时间**：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
- **协议**：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
- **首部检验和**：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
- **标识**: 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
- **片偏移**: 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

### IP地址

IP地址分为网络号（网络地址）和主机号（主机地址）。

> 一般来说，寻址的过程是这样的发起一个请求，首先这个请求根据域名查询DNS服务器查询到具体的IP地址（如果直接IP请求忽略此步）。IP地址通过网络地址可以路由到目的网络，经过路由器的层层转发后可以通过主机号找到主机，实现网络交互。

划分只是为了规范化管理，有效的划分可以节省更多的IP资源。

以下是理想情况下：
- A类保留政府机构
- B类分配给中等规模公司
- C类分配给需要的任何人
- D类地址用于网管专业配置地址
- E类地址用于研发人员的科研实验

但是绝大部分IP地址都被美国的机构浪费掉了（听说）。

#### A类地址

A类IP地址：由1个字节的网络地址和3个字节的主机地址，网络地址的最高位必须是“0”。如：0XXXXXXX.XXXXXXXX.XXXXXXXX.XXXXXXXX（X代表0或1）

A类IP地址范围：1.0.0.1---126.255.255.254

A类IP地址中的私有地址和保留地址：① 10.X.X.X是私有地址（所谓的私有地址就是在互联网上不使用，而被用在局域网络中的地址）。范围（10.0.0.1---10.255.255.254）② 127.X.X.X是保留地址，用做循环测试用的。

#### B类地址

B类IP地址：由2个字节的网络地址和2个字节的主机地址，网络地址的最高位必须是“10”。如：10XXXXXX.XXXXXXXX.XXXXXXXX.XXXXXXXX（X代表0或1）

B类IP地址范围：128.0.0.1---191.255.255.254。

B类IP地址的私有地址和保留地址：① 172.16.0.0---172.31.255.254是私有地址② 169.254.X.X是保留地址。如果你的IP地址是自动获取IP地址，而你在网络上又没有找到可用的DHCP服务器。就会得到其中一个IP。191.255.255.255是广播地址，不能分配。

#### C类地址

C类IP地址：由3个字节的网络地址和1个字节的主机地址，网络地址的最高位必须是“110”。如：110XXXXX.XXXXXXXX.XXXXXXXX.XXXXXXXX（X代表0或1）

B类IP地址范围：192.0.0.1---223.255.255.254。

C类地址中的私有地址：192.168.X.X是私有地址，常见于局域网。（192.168.0.1---192.168.255.255)

#### D类地址

D类地址：不分网络地址和主机地址，它的第1个字节的前四位固定为1110。

如：1110XXXX.XXXXXXXX.XXXXXXXX.XXXXXXXX（X代表0或1）

D类地址范围：224.0.0.1---239.255.255.254

#### E类地址

E类地址：不分网络地址和主机地址，它的第1个字节的前四位固定为 1111。

如：1111XXXX.XXXXXXXX.XXXXXXXX.XXXXXXXX（X代表0或1）

E类地址范围：240.0.0.1---255.255.255.254

#### 一些特殊的网络地址

1. 0.0.0.0：三无人员收容所，会收容所有不清楚的主机和目的网络。不清楚是指，路由表里没有特定条目指明如何到达。严格意义上说，这不是一个特定的IP地址。另外，这个地址在开发中的作用是可以接受任何IP的请求。例如，在tomcat配置表中设置监听IP为0.0.0.0，则表示该服务器监听所有的IP地址，任何IP都可以访问该服务器。
2. 127.0.0.1：localhost用于测试的一个地址，一般要在自己机器上测试接口或者什么功能的时候会用到这个。这个地址代表这台主机，除非出错，寻址是不能把它发送到网络接口的，所以传输介质中永远不回出现这个地址的数据包。
3. 私有地址：一般类似于192.168.xx.xx，10.xx.xx.xx，172.16.0.0---172.31.255.254之类的，这些地址被大量用于企业内部网络中。一些宽带路由器，也往往使用192.168.1.1作为缺省地址（比如需要修改路由器设置，可以尝试使用这个地址访问路由器）。私有网络由于不与外部互连，因而可能使用随意的IP地址。保留这样的地址供其使用是为了避免以后接入公网时引起地址混乱。使用私有地址的私有网络在接入Internet时，要使用地址翻译(NAT)，将私有地址翻译成公用合法地址。在Internet上，这类地址是不能出现的。
4. 169.254.x.x：如果你的主机使用了DHCP功能自动获得一个IP地址，那么当你的DHCP服务器发生故障，或响应时间太长而超出了一个系统规定的时间，计算机操作系统会为你分配这样一个地址。如果你发现你的主机IP地址是一个诸如此类的地址，很不幸的是，现在你的网络不能正常运行了。
5. 255.255.255.255：对本机来说，这个地址指本网段内(同一广播域)的所有主机。
6. 组播地址：注意它和广播的区别。从224.0.0.0到239.255.255.255都是这样的地址。224.0.0.1特指所有主机，224.0.0.2特指所有路由器。这样的地址多用于一些特定的程序以及多媒体程序。如果你的主机开启了IRDP(Internet路由发现协议），使用组播功能功能，那么你的主机路由表中应该有这样一条路由。

## 子网掩码

它是一种用来指明一个IP地址的哪些位标识的是主机所在的**网络地址**以及哪些位标识的是**主机地址**的位掩码。

这种说法太笼统了，只要是1的就是网络位，举个简单的例子：
> 1100前面1是网络位，后面0主机位。

写在前面：**子网掩码和划分以及最大主机数一开始学的时候有点不直观，其实这个锅不是学生自己而是不应该用十进制学这个，而是用二进制学。**

理解什么是子网掩码和如何划分，首先先看这个例子：在这里以192.168.0.3/26举例。首先，他的二进制是1100 0000.1010 1000.0000 0000.0000 0011这样的。/26是代表26位**掩码**。

掩码的解释，个人理解就是“盖住”的意思，例如一个掩码是1111 1111.1111 1111.1111 1111.0000 0000(255.255.255.0)则说明被1盖住的是网络位，剩下的是主机位。192.168.0.3/26的子网掩码：1111 1111.	1111 1111.1111 1111.1100 0000(255.255.255.192，这里有26个1)。

这样有什么用呢？
>假如给出192.168.1.10和192.168.1.201，计算机并不知道网络是哪个主机是哪个。那么我们就需要人为的划分一下在后面加一个后缀192.168.1.10/24，192.168.1.201/25这样就可以非常的标识出哪个网络下的哪个主机。而/24和/25（为了方便表示，使用十进制）则是子网掩码，轻松的划分出子网。

例题：PC的ip为192.168.0.3/26，最大可用主机数与广播地址分别是什么？
> 26代表有在子网掩码中26个1，就说明网络位有$2^{26}$个。有6个0代表主机位个数是$2^6-2$，最多有62个。
> 为什么$2^6-2$要-2，因为最后结尾的部分的x.x.x.0为网络地址，最后结尾的部分以x.x.x.255则为广播地址，二者并不能作为ip使用。
> 计算广播地址：$broadcast = netaddress || (~subnet mask)$。
> 显然公式是为了学术和写代码用的。通常情况下用更快捷的方法：192.168.0.3/26，32-26=6，$2^6-2$即最大可用主机数；也由此可推出广播地址为 x.x.x.最大可用主机数+1

## 网关

网关：网关定义了边界路由，即ip地址的出口，可以理解成国家之间的交界往返地，中国 <-> 珠穆朗玛峰 <-> 尼泊尔（不怎么严格的理解）
路由：是指把数据从一个地方传送到另一个地方的行为和动作，而路由器，正是执行这种行为动作的机器

> :: 路由器的作用简单文符示意图
> :: ✗ 否定；<——> 连接；✓ 可行；⊃ 自带完全有；
> :: A不能直接访问B
> A ——> ✗ ——> B
> :: A需要通过C才能与B进行互相通信传递信息，而这个C就是一个代理
> A <——> C <——> B ✓
> :: A只会汉语、B只会尼泊尔语，而C掌握二者的语言
> ::（这个语言可以理解成网关，而人也就可以理解成一台路由器），自然可以让双方进行信息传递
> C ⊃ gateway

判断两PC是否可以通信？
> PC1:192.168.1.3/26、PC2:192.168.1.70/26，两台PC是否能进行通信？
> 首先需要判断PC是否处于同一网段内
> 公式：IP地址 && 子网掩码 = 网络地址
> 192.168.1.3 && 255.255.255.192 = 192.168.1.0
> 192.168.1.70 && 255.255.255.0 = 192.168.1.64
> 显然192.168.1.0 ≠ 192.168.1.64，根据计算PC1与PC2的网络地址不同，由此得出PC1与PC2不能进行通信

一些以前工作的碎碎念，我之前做过一些水务相关的项目，其中，不可避免的接触到工业物联网（各种检测设备的使用）。
> 工业物联网网关不是简单家庭的智能物联网网关。工业物联网网关（以下都称作网关）承担着承上启下的作用。它的基本功能就是协议转换。网关将汇总所有数据，转换传感器的协议，并在发送数据之前对其进行预处理。
> 为什么这么说呢？因为工业物联网包括上位机（电脑或触屏监控系统、MES这些）和下位机（包括PLC、传感器、嵌入式芯片等）。基本需求就是下位机可能采集到数据需要传递到上位机，上位机下达指令传递到下位机。所以，工业物联网网关就像人的神经一样，可以传递感受器信号和大脑的指令。
> 其中基础功能就是数据采集和转发功能。可以将现场的传感器，仪表，PLC等设备通过总线接口（例如CAN,RS485），wifi，4/5G等连接到网关。而网关可以根据适配协议（例如TCP/IP,MQTT等）对信息进行转发。而且还可以实时控制、远程监控设备。
> 另外，还有需要存储和端点续传功能。可以有效防止数据丢失。
> 边缘计算功能。可以做一部分数据预处理工作和数据标准化。
> 之前有人问我为什么不用家用路由器。我的回答是，我做项目模型，做可行性研究的时候用的就是家用路由器，完全没问题的。但是工业中要求的三防指标和性能要求非常高，稳定性也要求高得多，而且工业物联网网关中的功能，家用路由器没有。所以，只能选择工业物联网网关（我曾经见过用家用路由器的，公司是真的穷，产品是真的不稳定）。
> 还有一种网关是Spring Cloud Gateway，这个不是传统意义上的网关，只是可以执行类网关的功能，在spring boot进行说明。

### 广播地址

广播地址分为两种：

- 本地广播地址
- 全局广播地址

#### 本地广播地址

每个网段中的最后一个IP地址是本地广播地址，比如192.168.1.0/24地址范围是192.168.1.0~255，IP地址是192.168.1.255就是本地广播地址。

作用是发送的数据是**此网段**中所有的设备。比如A设备192.168.1.1/24，发送数据的目的ip是本地广播地址(192.168.1.255)，这时候接收者就是配置了192.168.1.0~255的ip地址的所有设备（不同网段的不会发送）。

> 有几个问题：
> 1. 同网段的本地广播地址可能不一样
> 比如192.168.1.200/24本地广播地址192.168.1.255，网段地址范围是192.168.1.0~255，包含了1.201地址192.168.1.201/16本地广播地址192.168.255.255，网段地址范围是192.168.0~255.0~255，包含了1.200地址因为相互包含，所以是同网段，但本地广播地址不一样。
> 2. 相同的本地广播地址可能不在通一网段
> 比如192.168.1.10/24 本地广播地192.168.1.255，网段地址范围是192.168.1.0~255，包含了1.201地址192.168.1.201/25 本地广播地址192.168.1.255，网段地址范围是192.168.1.128~255，没有包含1.10地址虽然本地广播地址一样，但网段没有相互包含，所以不在同网段。
> 以上两个场景需要在开发过程中注意。

#### 全局广播地址

网络IP地址中的最后一个IP地址，255.255.255.255，特殊地址。

作用是发送数据的目的如果为255.255.255.255，所有设备必须处理此广播包（就算不同网段的都需要处理）。

> 关于广播地址的应用：
> 之前接手过一个项目，原型是主机（Linux系统）远程监控多个从机（安卓系统）。项目需求是，从机定时发送心跳信息。但由于主机IP是随机分配的，设备开机后从机无法获取主机IP，所以需要使用广播，对该路由器内的从机发送主机IP以及其他信息。
> 以此为原型，可以做设备探查等功能，好像有人说海康的客户端也用这个功能去探测局域网内的IP摄像头。

**注意广播风暴！！！**

广播风暴（broadcast storm）简单的讲是指当**广播数据充斥网络无法处理，并占用大量网络带宽，导致正常业务不能运行，甚至彻底瘫痪，这就发生了“广播风暴”。**一个数据帧或包被传输到本地网段 （由广播域定义）上的每个节点就是广播；由于网络拓扑的设计和连接问题，或其他原因导致广播在网段内大量复制，传播数据帧，导致网络性能下降，甚至网络瘫痪，这就是广播风暴。

原因：1、不合理的网络划分。比如很多客户机处于同一个网段内。由于ARP、DHCP都是广播包的形式，那么有时候就会产生广播风暴。2、环路。环路时，数据包会不断的重复传输，也一样会产生广播风暴。

这两者中，环路的情况比较恶性，需要网管人员立即进行排除；而网段划分引起的广播风暴比较良性，一般对网络的影响较小。

关于分析和二层广播风暴，先埋个坑，以后再补:)

### 总结

以上就是关于IP的一些内容。个人感觉还是比较重要的，在工程中需要对设备进行组网，或者内部搭建网络结构，需要对IP以及子网有深刻的了解。做一下简单的总结和串联：
1. 首先为了能找到分布在不同地点的设备，发明出IP，IP一部分能指示网络一部分能指示设备。
2. 那么如何知道哪一部分是网络，哪一部分是主机呢？使用子网划分。
3. 知道了哪些是网络位，那么就要使用网络位通过路由器和中间设备不停的转发，找到目的主机。那么中间就会遇到各个网关，经过一系列的协议和规则进行转发后到达目的主机。

### 关于IP的八股文

1. IP地址的定义：
    > IP 协议（Internet Protocol）又被称为互联网协议，是支持网间互联的**数据包协议**，工作在**网际层**，主要目的就是为了提高网络的可扩展性。
    通过网际协议 IP，可以把参与互联的，性能各异的网络看作一个统一的网络。和传输层 TCP 相比，IP 协议是一种无连接/不可靠、尽力而为的数据包传输服务，和 TCP 协议一起构成了 TCP/IP 协议的核心。
2. IP 协议主要的作用：
    > - **寻址和路由**：在 IP 数据报中携带源 IP 地址和目的 IP 地址来表示该数据包的源主机和目标主机。IP 数据报在传输过程中，每个中间节点（IP 网关、路由器）只根据网络地址来进行转发，如果中间节点是路由器，则路由器会根据路由表选择合适的路径。IP 协议根据路由选择协议提供的路由信息对 IP 数据报进行转发，直至目标主机。
    > - **分段和重组**：IP 数据报在传输过程中可能会经过不同的网络，在不同的网络中数据报的最大长度限制是不同的，IP 协议通过给每个 IP 数据报分配一个**标识符以及分段与组装的相关信息**，使得数据报在不同的网络中能够被传输，被分段后的 IP 数据报可以独立地在网络中进行转发，**在达到目标主机后由目标主机完成重组工作，恢复出原来的 IP 数据报。**
3. 传输层协议和网络层协议有什么区别？
    > 网络层协议负责提供**主机间**的逻辑通信；传输层协议负责提供**进程间**的逻辑通信。
4. IP 地址有哪些分类？
    > 一个 IP 地址在这鞥个互联网范围内是惟一的，一般可以这么认为，IP 地址 = {<网络号>，<主机号>}。
    > 网络号：它标志主机所连接的网络地址表示属于互联网的哪一个网络。
    > 主机号：它标志主机地址表示其属于该网络中的哪一台主机。
    > IP 地址分为 A，B，C，D，E 五大类：
    > - A 类地址 (1~126)：以 0 开头，网络号占前 8 位，主机号占后面 24 位。
    > - B 类地址 (128~191)：以 10 开头，网络号占前 16 位，主机号占后面 16 位。
    > - C 类地址 (192~223)：以 110 开头，网络号占前 24 位，主机号占后面 8 位。
    > - D 类地址 (224~239)：以 1110 开头，保留为多播地址。
    > - E 类地址 (240~255)：以 1111 开头，保留位为将来使用
5. 域名和 IP 的关系？一个 IP 可以对应多个域名吗？
    > - IP 地址在同一个网络中是惟一的，用来标识每一个网络上的设备，其相当于一个人的身份证号
    > - 域名在同一个网络中也是惟一的，就像是一个人的名字、绰号
    > 假如你有多个不用的绰号，你的朋友可以用其中任何一个绰号叫你，但你的身份证号码却是惟一的。但同时你的绰号也可能和别人重复，假如你不在，有人叫你的绰号，其它人可能就答应了。
    > 一个域名可以对应多个 IP，但这种情况**DNS做负载均衡**的，在用户访问过程中，一个域名只能对应一个 IP。而一个 IP 却可以对应多个域名，是一对多的关系。
6. IPV4 地址不够如何解决？
    > - DHCP：动态主机配置协议，动态分配 IP 地址，只给接入网络的设备分配 IP 地址，因此同一个 MAC 地址的设备，每次接入互联网时，得到的 IP 地址不一定是相同的，该协议使得空闲的 IP 地址可以得到充分利用。
    > - CIDR：无类别域间路由。CIDR 消除了传统的 A 类、B 类、C 类地址以及划分子网的概念，因而更加有效地分配 IPv4 的地址空间，但无法从根本上解决地址耗尽的问题。
    > - NAT：网络地址转换协议，我们知道属于不同局域网的主机可以使用相同的 IP 地址，从而一定程度上缓解了 IP 资源枯竭的问题，然而主机在局域网中使用的 IP 地址是不能在公网中使用的，当局域网主机想要与公网主机进行通信时，NAT 方法可以将该主机 IP 地址转换为全球 IP 地址。该协议能够有效解决 IP 地址不足的问题。
    > - IPv6：作为接替 IPv4 的下一代互联网协议，其可以实现 2 的 128 次方个地址，而这个数量级，即使给地球上每一粒沙子都分配一个 IP 地址也够用，该协议能够从根本上解决 IPv4 地址不够用的问题。

## 地址解析协议 ARP

**ARP 协议，Address Resolution Protocol，地址解析协议，它是用于实现 IP 地址到 MAC 地址的映射。**
在网络通信中，主机和主机通信的数据包需要依据OSI模型从上到下进行数据封装，当数据封装完整后，再向外发出。所以在局域网的通信中，不仅需要源目IP地址的封装，也需要源目MAC的封装。一般情况下，上层应用程序更多关心IP地址而不关心MAC地址，所以需要通过ARP协议来获知目的主机的MAC地址，完成数据封装。

关于解析过程参考：
> [图解ARP协议](https://zhuanlan.zhihu.com/p/28771785)
大概过程简单说一下：首先路由设备会维护一个映射表，如果A发送信息到B，一开始的空表会记录A的MAC和IP的信息，这样映射表就有设备A的信息了。然后B收到信息后会返回一个消息给A，同样也经过路由设备，此时路由设备就会新加B的信息。

上面的复制来的废话可以不用看，可以直接看八股文。对于为什么需要ARP协议，八股文里有几个题目可以解答。

### 八股文

1. MAC 地址和 IP 地址都有什么作用？

    > - MAC地址：MAC地址是数据链路层使用的地址，是写在网卡上的物理地址，不可更改。
    > - IP地址：是网络层和以上各层使用的地址，是一种逻辑地址。IP 地址用来区别网络上的计算机。

2. 为什么有了 MAC 地址还需要 IP 地址？

    > 有两方面：
    > - MAC地址是标记单个设备的，假如使用MAC去替代IP，在这种情况下，设备进行交互就需要满世界的去找对应的MAC，这显然是不合理的。假如规定出先通过MAC的哪一部分找到子网，再缩小范围，这样就变成了IP，所以还得是IP好用。
    > - 另外，现在的MAC地址是48位的，如果用MAC作为地址寻址路由器就要记住$2^{48}$次方个地址，差不多256T，路由器存不下这么多地址。

3. 为什么有了 IP 地址还需要 MAC 地址？
    > - 只有当设备连入网络时，才能根据他进入了哪个子网来为其分配 IP 地址，在设备还没有 IP 地址的时候，或者在分配 IP 的过程中。我们需要 MAC 地址来区分不同的设备。
    > - [对于MAC和IP的关系的举例说明](#对于mac和ip的关系的举例说明)

### 对于MAC和IP的关系的举例说明

通过增加网络中计算机的数量来说明：

1. 第一个阶段只有两三台计算机，开个网口就可以。用不到IP，只需要一个ID，这个ID就是MAC地址。
2. 第二个阶段计算机的数量增加到五六台，就不可以简单的使用开网口的方式。而是需要一个设备将计算机串联起来，这个设备就是**集线器**，它可以把数据包发给所有的出口，类似于广播的形式。计算机通过MAC地址就可以知道谁发消息给谁了，如果接收到的消息是发给自己的就留下，否则就丢弃。
3. 第三个阶段，如果希望有一个用更加智能的方法来转发消息的设备，这就是**交换机**，在交换机中，会维护一个表，这个表就是端口（出口）和MAC地址的映射。假如MAC地址为aa的设备发送到MAC地址为bb的设备，首先会查询bb的端口是什么然后再发送，这样就不是广播，而是一对一了（有了这个功能，市场上的交换机比集线器贵得多，但是选择还需要跟项目需求判断，比如少量设备间心跳传递就可以只是用集线器）。
4. 当设备量增加到第四个阶段，需要一个市，一个省的的计算机串联起来。这种情况下交换机无能为力，则会选择一个支持**路由转发功能**的设备。这个设备就是**路由器**，它的功能是作为一个**有独立地址**的**可以进行路由转发**的设备，将数据进行转发。其中，独立地址就是IP地址，转发消息可以根据维护的路由表，把消息转发给下层设备或主机。

总的来说，IP是收件地址，可以精准到那个路由器；MAC是收件人可以精确到那个设备。

### 一个小总结

以[对于MAC和IP的关系的举例说明](#对于mac和ip的关系的举例说明)为背景的总结。

1. A给C发数据包，如何知道通过路由器转发？
    > 通过子网，如果不在同一子网，肯定需要路由器转发。
2. A如何知道那个是路由器？
    > 发给网关，如果设备要发消息给其他子网的设备，必须经过网关。
3. 路由器怎么知道各个设备在哪里？
    > 路由表，路由器会维护一个路由表去表示下一条在哪里（插播一句，可以看一下TTL关于跳数问题），具体路由算法有很多。

总结到这里，会清楚的发现当只知道网络层（IP）的数据包需要发消息给对方（也只知道IP）时，发过去的时候要经过对方的数据链路层，所以必须要知道网络层的IP和数据链路层的MAC的对应关系。所以需要ARP协议去做转换。

## 网际控制报文协议 ICMP

ICMP是 Internet Control Message Protocol 的缩写，即互联网控制消息协议。它是互联网协议族的核心协议之一。它用于 TCP/IP 网络中发送控制消息，提供可能发生在通信环境中的各种问题反馈，通过这些信息，使网络管理者可以对所发生的问题作出诊断，然后采取适当的措施解决问题。虽然 ICMP 是**网络层**协议，但是它不像 IP 协议和 ARP 协议一样直接传递给数据链路层，而是先封装成 IP 数据包然后再传递给数据链路层。所以在 IP 数据包中如果协议类型字段的值是 1 的话，就表示 IP 数据是 ICMP 报文。IP 数据包就是靠这个协议类型字段来区分不同的数据包的。


### 八股文

1. ping的原理是什么？
> ping，Packet Internet Groper，是一种因特网包探索器，用于测试网络连接量的程序。Ping 是工作在 TCP/IP 网络体系结构中**应用层**的一个服务命令， **主要是向特定的目的主机发送 ICMP（Internet Control Message Protocol 因特网报文控制协议） 请求报文**，测试目的站是否可达及了解其有关状态。
> 一般来说，ping 可以用来检测网络通不通。它是基于ICMP协议工作的。假设机器 A ping 机器 B，工作过程如下：
> 1. ping 通知系统，新建一个固定格式的 ICMP 请求数据包
> 2. ICMP 协议，将该数据包和目标机器 B 的 IP 地址打包，一起转交给 IP 协议层
> 3. IP 层协议将本机 IP 地址为源地址，机器 B 的 IP 地址为目标地址，加上一些其他的控制信息，构建一个 IP 数据包
> 4. 先获取目标机器 B 的 MAC 地址
> 5. 数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址是本机的 MAC 地址
> 6. 机器 B 收到后，对比目标地址，和自己本机的 MAC 地址是否一致，符合就处理返回，不符合就丢弃
> 7. 根据目的主机返回的 ICMP 回送回答报文中的时间戳，从而计算出往返时间
> 8. 最终显示结果有这几项：发送到目的主机的 IP 地址、发送 & 收到 & 丢失的分组数、往返时间的最小、最大 & 平均值
> 
> 加入一点点自己的想法：之前做项目经常用到心跳包，所谓心跳包是指定期地发送一定格式的指令判断线程或进程是否存活。举个例子，在安卓5.0时，如何维护服务后台存活就是需要一个守护进程（或线程）不断判断并拉起后台服务。包括工业物联网上也会主动向设备发送心跳包判断设备状态。

## 虚拟专用网 VPN

由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

举个例子：假设公司局域网有台IP地址为192.168.1.3的机器A。当我连上公司局域网是可以正常访问A的。但是当我回家的时候就连不上去了，因为电信机构并不知道192.168.1.3在哪里。
所以，有两个方案可以解决：1. 公司每个机器都分配一个公网IP，显然是不现实的。2. 使用中间人互通，这就是VPN技术。
简单来说，VPN技术就是将一台拥有公网IP的设备作为中间人，多个网络可以和中间人进行互通，当自己的设备访问公司网络时，需要将信息先发送给中间人，中间人分析路由后再转发到真实的地址。由于VPN技术用在大型企业和各个子公司之间的互通，所以加密通信也是非常重要的。

> 这个与**代理**还是有区别的，代理是使用一台新的设备, 帮助当前设备完成所有的网络通信。
> 具体来说，就是中间有台服务器A作为代理转发你的请求，比如，访问推特，我将请求信息发送到A然后A再转发给推特服务器。这样，推特服务器只知道A与服务器交互并不知道我的存在。这样看来，代理技术带来的另外一点是，隐藏自己信息，降低暴露风险。但是，由于是没有加密的，所以如果想避开监管还是需要做加密处理（市面上的加速器基本用的都是代理，而且不加密，而且还泄露个人信息，不安全）。
> 很多加速器是TUN/TAP代理原理开发的（看看就好）。
> - TUN : tunnel 隧道
> - TAP : network tap 桥接

**仅限学术研究和交流，私自搭建VPN和代理服务器是违法行为。**
